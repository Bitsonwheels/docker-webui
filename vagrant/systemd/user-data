#cloud-config

coreos:
  update:
    group: stable
    reboot-strategy: off

  units:
    - name: docker-tcp.socket
      command: start
      enable: true
      content: |
        [Unit]
        Description=Docker Socket for the API

        [Socket]
        ListenStream=2375
        BindIPv6Only=both
        Service=docker.service

        [Install]
        WantedBy=sockets.target

    - name: ap.service
      command: start
      content: |
        [Unit]
        Description=Docker restarter
        After=docker.service
        Requires=docker.service

        [Service]
        ExecStartPre=-/usr/bin/docker kill ap
        ExecStartPre=-/usr/bin/docker rm ap
        ExecStart=/usr/bin/docker run --name ap \
                      -e CONFIG_FILE_PATH=/go/src/github.com/pottava/docker-webui/config.json \
                      -v /home/core/share:/go/src/github.com/pottava/docker-webui \
                      -v /var/run/docker.sock:/var/run/docker.sock \
                      -p 80:9000 \
                      pottava/docker-webui:base \
                      go run /go/src/github.com/pottava/docker-webui/main.go
        ExecStop=/usr/bin/docker kill ap
